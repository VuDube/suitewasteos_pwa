#!/usr/bin/env node
/**
 * Bun CLI shim for npm scripts
 *
 * Purpose:
 * - Intercept "bun run build" and "bun build" (when no explicit entrypoints provided)
 *   and forward them to: `npm run build`
 * - Allow additional args to be forwarded to npm run build when passed after `--`
 * - For all other bun invocations, forward to the system bun binary at /usr/local/bin/bun
 *
 * Implementation details:
 * - Uses spawnSync to synchronously run child processes and inherit stdio
 * - Exits the shim process with the exact child process status code
 * - Falls back to invoking `bun` from PATH if /usr/local/bin/bun is not present
 *
 * Note: This file is intended to be placed at node_modules/.bin/bun and contains a
 * Node.js shebang so it can be executed directly by package managers or scripts.
 */
'use strict';
const { spawnSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const ARGS = process.argv.slice(2);
/**
 * Determine whether the provided args (after "build") contain an entrypoint.
 * An entrypoint is considered any argument that:
 *  - does not start with '-' (i.e., not an option)
 *  - is not the double-dash '--' separator
 *
 * @param {string[]} argsAfterBuild - arguments that follow the 'build' subcommand
 * @returns {boolean} true if there is at least one entrypoint
 */
function hasEntrypoints(argsAfterBuild) {
  for (const a of argsAfterBuild) {
    if (a === '--') break; // arguments after -- are not considered direct entrypoints for this check
    if (!a.startsWith('-')) {
      return true;
    }
  }
  return false;
}
/**
 * Spawn a child process synchronously and exit with its status code.
 *
 * @param {string} cmd - command to run
 * @param {string[]} args - arguments array
 */
function runAndExit(cmd, args) {
  try {
    const res = spawnSync(cmd, args, { stdio: 'inherit' });
    if (res.error) {
      // Show error and exit non-zero
      console.error(`Error invoking ${cmd}:`, res.error);
      process.exit(res.status || 1);
    }
    // If process was terminated by signal, print and exit 1
    if (res.signal) {
      console.error(`${cmd} terminated by signal: ${res.signal}`);
      process.exit(1);
    }
    process.exit(res.status === null ? 0 : res.status);
  } catch (err) {
    console.error(`Failed to invoke ${cmd}:`, err);
    process.exit(1);
  }
}
// Main interception logic
(function main() {
  // No args: just forward to system bun
  if (ARGS.length === 0) {
    // Forward to system bun
    const systemBun = '/usr/local/bin/bun';
    if (fs.existsSync(systemBun)) {
      runAndExit(systemBun, ARGS);
    } else {
      // fallback to PATH bun
      runAndExit('bun', ARGS);
    }
    return;
  }
  const first = ARGS[0];
  let intercept = false;
  let npmArgs = ['run', 'build'];
  if (first === 'run' && ARGS.length >= 2 && ARGS[1] === 'build') {
    // bun run build [-- <extra>]
    intercept = true;
    const dd = ARGS.indexOf('--');
    if (dd !== -1) {
      const extra = ARGS.slice(dd + 1);
      if (extra.length > 0) {
        // Preserve the conventional separator for npm to pass through
        npmArgs = npmArgs.concat(['--', ...extra]);
      }
    }
  } else if (first === 'build') {
    // bun build [<entrypoints|options>]
    const afterBuild = ARGS.slice(1);
    const hasEntries = hasEntrypoints(afterBuild);
    if (!hasEntries) {
      // No entrypoints => treat like project build, forward to npm
      intercept = true;
      const dd = ARGS.indexOf('--');
      if (dd !== -1) {
        const extra = ARGS.slice(dd + 1);
        if (extra.length > 0) {
          npmArgs = npmArgs.concat(['--', ...extra]);
        }
      }
    } else {
      // There are entrypoints: allow system bun to handle bundling
      intercept = false;
    }
  }
  if (intercept) {
    // Run npm run build instead of bun build
    runAndExit('npm', npmArgs);
  } else {
    // Forward everything to system bun
    const systemBun = '/usr/local/bin/bun';
    if (fs.existsSync(systemBun)) {
      runAndExit(systemBun, ARGS);
    } else {
      // fallback to PATH bun
      runAndExit('bun', ARGS);
    }
  }
})();